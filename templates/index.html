{% extends 'base.html' %}

{% load static %}
{% load compress %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="sticky-top float-right pt-5 pr-5">
  <div id="year-toggle">
    <div class="dropdown">
      <button class="btn btn-secondary dropdown-toggle" type="button" id="yearDropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        {{ data_years.0 }}
      </button>
      <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
        {% for year in data_years %}
          <a class="dropdown-item year-dropdown-item" href="#{{ year }}">{{ year }}</a>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<div class="clearfix"></div>

<div class="row pt-0">
  <div class="col-lg-8 offset-lg-2">
    <h3>Illinois Public Pensions Database</h3>

    <p class="lead">The pension crisis affecting the state of Illinois, Cook County and the city of Chicago spurs vigorous debate about the reasons it became Illinois’ most vexing problem and little agreement about how to solve it.</p>

    <p>The Better Government Association seeks to provide clarity on this important topic with our updated Illinois Public Pensions Database.</p>

    <p>With this updated database, readers can analyze how well (or how poorly) the 17 largest public-sector pension funds in the state are funded, the percentage of funding levels and how much in liabilities each of the pension funds face.</p>
  </div>
</div>

<div id="funding-by-system">
  <div class="row pt-5 pb-5">

    <div class="col-lg-10 offset-lg-1">
      <h3 class="pb-4"><strong>Pension Liability by System</strong></h3>
    </div>

    <div class="col-lg-5 offset-lg-1">
      <div class="row">
        <div class="col-lg-6">
          <h4 class="chart-title">State Pension Liability</h4>
          <h5 class="chart-subtitle"><span class="data-year"></span></h4>
        </div>
        <div class="col-lg-6 text-center">
          <small class="text-uppercase">Total Liability</small><br />
          <h2>$<span id="total-state-liability"></span></h2>
        </div>
      </div>
      <div id="state-container"></div>
    </div>

    <div class="col-lg-5">
      <div class="row">
        <div class="col-lg-6">
          <h4 class="chart-title">County Pension Liability</h4>
          <h5 class="chart-subtitle"><span class="data-year"></span></h4>
        </div>
        <div class="col-lg-6 text-center">
          <small class="text-uppercase">Total Liability</small><br />
          <h2>$<span id="total-county-liability"></span></h2>
        </div>
      </div>
      <div id="county-container"></div>
    </div>

    <div class="col-lg-5 offset-lg-1">
      <div class="row">
        <div class="col-lg-6">
          <h4 class="chart-title">Chicago Municipal Pension Liability</h4>
          <h5 class="chart-subtitle"><span class="data-year"></span></h4>
        </div>
        <div class="col-lg-6 text-center">
          <small class="text-uppercase">Total Liability</small><br />
          <h2>$<span id="total-chicago-liability"></span></h2>
        </div>
      </div>
      <div id="chicago-container"></div>
    </div>

    <div class="col-lg-5">
      <div class="row">
        <div class="col-lg-6">
          <h4 class="chart-title">Downstate Municipal Pension Liability</h4>
          <h5 class="chart-subtitle"><span class="data-year"></span></h4>
        </div>
        <div class="col-lg-6 text-center">
          <small class="text-uppercase">Total Liability</small><br />
          <h2>$<span id="total-downstate-liability"></span></h2>
        </div>
      </div>
      <div id="downstate-container"></div>
    </div>

  </div>
</div>

<div class="row pt-5 pb-5 hidden" id="funding-by-system-no-data">
  <div class="col-lg-10 offset-lg-1">No data :-(</div>
</div>

<div class="row">
  <div class="col-lg-8 offset-lg-2">
    <p>You can also examine a year-by-year, fund-by-fund breakdown of <strong>“employer normal cost”</strong> vs. <strong>“amortization cost.”</strong></p>

    <p>What does that mean?</p>

    <p><strong>“Employer normal cost”</strong> is a subset of a pension’s “normal cost” — the estimated price of fully funding the benefits earned by employees in a given year. So “employer normal cost” is the normal cost of the plan minus employee contributions.</p>

    <p>Employees pay their share through payroll deductions, but employers (the governments) have rarely, if ever, paid their full share, even when more robust payments under a nearly quarter-century financial rescue plan are taken into account.</p>

    <p><strong>“Amortization cost”</strong> is the present cost of making up for insufficient payments in the past.</p>

    <p>Employer normal cost is usually well less than half the total cost government bodies kick in each year to pay for their current and past pension obligations. The disconnect between employer normal cost and the total contribution made by employers is a good measure of how well a pension fund was funded in the past.</p>
  </div>
</div>

<div class="sticky-top pt-5 pl-5 text-center float-left">
  <div id="fund-toggle">
    <div class="dropdown">
      <button class="btn btn-secondary dropdown-toggle" type="button" id="fundDropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
      </button>
      <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
        {% for fund in pension_funds %}
          <a class="dropdown-item fund-dropdown-item" href="#{{ fund }}">{{ fund }}</a>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<div class="clearfix"></div>

<div id="fund-detail">

  <div class="row pt-5">
    <div class="col-lg-6 offset-lg-1">
      <div class="row">
        <div class="col-lg-6">
          <h4 class="chart-title">Pension Liability</h4>
          <h5 class="chart-subtitle"><span class="employer-name"></span> – <span class="employer-data-year"></span></h4>
        </div>
        <div class="col-lg-4 text-center my-auto">
          <small class="text-uppercase">Total Liability</small><br />
          <h2>$<span id="employer-liability-amount"></span></h2>
        </div>
      </div>
    </div>
  </div>

  <div class="row pt-3 h-100 text-center">
    <div class="col-lg-6 offset-lg-1">
      <div id="fund-container"></div>
    </div>
    <div class="col-lg-4 my-auto">
      <small class="text-uppercase">Funding Level</small><br />
      <h1><span id="funding-level" class="badge badge-danger"></span></h1>
    </div>
  </div>

  <div class="row py-5">
    <div class="col-lg-6 offset-lg-1">
      <h4 class="chart-title">Distribution of Employer Contribution</h4>
      <h5 class="chart-subtitle"><span class="employer-name"></span> – <span class="employer-data-year"></span></h4>
    </div>
    <div class="col-lg-4 text-center my-auto">
      <small class="text-uppercase">Total Employer Contribution</small><br />
      <h2>$<span id="employer-contribution-amount"></span></h2>
    </div>
  </div>

  <div class="row">
    <div id="amortization-cost" class="col-lg-10 offset-lg-1"></div>
  </div>

</div>

<div class="row pt-5 pb-5 hidden" id="fund-detail-no-data">
  <div class="col-lg-10 offset-lg-1">No data :-(</div>
</div>

<div class="row pt-5">
  <div class="col-lg-8 offset-lg-2">
    <p>What’s more, as the BGA has since 2012, users will be able to track the money paid to thousands of retired public-sector employees in Illinois. This is searchable information from the pension funds, including Chicago, Cook County and statewide. You can use this tool to find out how these break these down on an annual basis.</p>

    <p>PS: This is data only for the 17 largest pension funds in Illinois and does not include the 600+ police and fire pension funds peppered throughout Illinois, many of which are also in fiscal trouble.</p>
  </div>
</div>

<div class="row pt-5">
  <div class="col-lg-10 offset-lg-1">
    <h2>Search <span class="employer-data-year"></span> <span class="employer-name"></span> Individual Pension Data</h2>
  </div>
</div>

<div class="row pt-5">
  <div class="col-lg-6 offset-lg-1">
    <h4 class="chart-title">Distribution of Individual Benefits</h4>
    <h5 class="chart-subtitle pb-2"><span class="employer-name"></span> – <span class="employer-data-year"></span></h4>
    <div id="benefit-distribution-chart"></div>
  </div>
  <div class="col-lg-4 text-center my-auto">
    <p>
      <small class="text-uppercase">Median Annual Benefit</small><br />
      <h2 class="pb-3">$<span id="median-benefit-amount"></span></h2>
    </p>

    <p>
      <small class="text-uppercase">Number of Benefits</small><br />
      <h2><span id="total-benefits"></span></h2>
    </p>
  </div>
</div>

<div class="row pt-5">
  <div class="col-lg-10 offset-lg-1">
    <p>
      <small>Search <span class="employer-data-year"></span> individual benefit data by full name, or by first or last name. For example, you can find <strong>John Doe</strong> by querying <em>John Doe</em>, <em>Doe</em>, or <em>John</em>. If searching by full name does not return the desired result, try a less specific first or last name search.</small>
    </p>

    <table class="table table-striped table-bordered" id="benefit-table">
      <thead>
        <tr>
          <th scope="col">First name</th>
          <th scope="col">Last name</th>
          <th scope="col">Amount</th>
          <th scope="col">Years of Service</th>
          <th scope="col">Final Salary</th>
          <th scope="col">Benefit Start Date</th>
          <th scope="col">Status</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    </table>
  </div>
</div>

<footer class="footer bg-dark mt-5 pt-5 pb-3">
  <div class="container-fluid text-center">
      <h4 class="text-uppercase mb-1">Illinois Public Salaries Database</h4>
      <p>
        <a href="/"><i class="fas fa-home fa-fw"></i> Home</a> |
        <a href="#"><i class="fas fa-question fa-fw"></i> User Guide</a>
      </p>

      <a href="https://bettergov.org" class="navbar-brand mt-3">
        <img src="{% static 'img/bga_logo.png' %}" alt="Home" class="header__logo-image" />
      </a><br />
      <p>
        <strong>Better Government Association</strong>
      </p>
      <p>
        223 W Jackson Blvd, Suite 300<br />
        Chicago, IL 60606<br />
        TEL (312) 427-8330
      </p>

      <p class="mt-5">
        Website by <a href="https://datamade.us"><img src="{% static 'img/datamade_logo.png' %}" alt="Home" class="datamade-logo align-top ml-1" /></a>
      </p>

      <p class="mt-5">
        <a href="https://auth0.com/?utm_source=oss&amp;utm_medium=gp&amp;utm_campaign=oss" target="_blank" alt="Single Sign On &amp; Token Based Authentication - Auth0"><img src="{% static 'img/a0-badge-dark.png' %}" width="150" height="50" /></a>
      </p>
  </div>
</footer>
{% endblock %}

{% block extra_js %}
<script src="{% static 'lib/highcharts.js' %}"></script>
<script src="https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.18/js/dataTables.bootstrap4.min.js"></script>
{% compress js %}
  <script type="module" src="{% static 'js/base.js' %}"></script>
  <script type="module">
    import { PensionsController, ChartHelper } from "js/base"

    var yearData = {{ data_by_year|safe }};
    var selectedYear = 2018;
    var selectedFund = 'Downstate/Suburban Teachers (TRS)';

    var chartHelper = new ChartHelper();
    var controller = new PensionsController(yearData, selectedYear, selectedFund, chartHelper, benefitTable);

    function makeAjaxUrl (currentController) {
      return "{% url 'benefit_list_json' %}" +
        '?data_year=' + controller.selectedYear +
        '&fund=' + controller.selectedFund;
    }

    controller.selectYear(selectedYear);
    controller.selectFund(selectedFund);

    // TODO: Maybe don't do this on mobile?
    $('#funding-by-system-no-data').css('min-height', $('#funding-by-system').height());
    $('#fund-detail-no-data').css('min-height', $('#fund-detail').height());

    var benefitTable = $('#benefit-table').DataTable({
      "dom": "Bfrtip",
      "order": [[ 2, "desc" ]],
      "columnDefs": [{ "orderable": false, "targets": [0, 6] }],
      "processing": true,
      "serverSide": true,
      "ajax": makeAjaxUrl(controller)
    });

    $('.year-dropdown-item').click(function () {
      var selectedYear = $(this).text();

      controller.selectYear(selectedYear);
      controller.selectFund(controller.selectedFund);

      benefitTable.ajax.url(makeAjaxUrl(controller)).load();
    });

    $('.fund-dropdown-item').click(function () {
      var selectedFund = $(this).text();

      controller.selectFund(selectedFund);

      benefitTable.ajax.url(makeAjaxUrl(controller)).load();
    });
  </script>
{% endcompress %}
{% endblock %}
