{% extends 'base.html' %}

{% load static %}
{% load compress %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="clearfix sticky-top">
  <div class="pt-5 pr-5 float-right">
    <div id="year-toggle">
      <div class="dropdown">
        <button class="btn btn-secondary btn-lg dropdown-toggle" type="button" id="yearDropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          {{ data_years.0 }}
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
          {% for year in data_years %}
            <span class="dropdown-item year-dropdown-item">{{ year }}</span>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row pt-0">
  <div class="col-lg-8 offset-lg-2">
    <h3>Illinois Public Pensions Database</h3>

    <p class="lead">The pension crisis affecting the state of Illinois, Cook County and the city of Chicago spurs vigorous debate about the reasons it became Illinois’ most vexing problem and little agreement about how to solve it.</p>

    <p>The Better Government Association seeks to provide clarity on this important topic with our updated Illinois Public Pensions Database.</p>

    <p>With this updated database, readers can analyze how well (or how poorly) the 17 largest public-sector pension funds in the state are funded, the percentage of funding levels and, how much in liabilities each of the pension funds face. Readers can also <a href="#search">search individual pension benefits</a>. <a href="https://salary.bettergov.org">The Illinois Public Salaries Database</a> provides complementary data on how much public employees in Illinois are paid.</p>

    <div class="alert alert-secondary my-4" role="alert">
      <i class="fas fa-info-circle fa-fw"></i> <strong>Use the dropdown menu</strong> at the top right of your screen view data from other years.
    </div>

    <p class="text-center">
      <small>Looking for a person? <a href="#search">Jump to individual benefit search <i class="fas fa-arrow-circle-down"></i></a></small>
    </p>
  </div>
</div>

<div id="funding-by-system">
  <div class="row pt-5 pb-5">

    <div class="col-lg-10 offset-lg-1">
      <h3 class="pb-4"><strong>Pension Liability by System</strong></h3>
    </div>

    <div class="col-lg-5 offset-lg-1">
      <div class="row">
        <div class="col-lg-6">
          <h4 class="chart-title">State Pension Liability</h4>
          <h5 class="chart-subtitle"><span class="data-year"></span></h4>
        </div>
        <div class="col-lg-6 text-center">
          <small class="text-uppercase">Total Liability</small><br />
          <h2>$<span id="total-state-liability"></span></h2>
        </div>
      </div>
      <div id="state-container"></div>
    </div>

    <div class="col-lg-5">
      <div class="row">
        <div class="col-lg-6">
          <h4 class="chart-title">County Pension Liability</h4>
          <h5 class="chart-subtitle"><span class="data-year"></span></h4>
        </div>
        <div class="col-lg-6 text-center">
          <small class="text-uppercase">Total Liability</small><br />
          <h2>$<span id="total-county-liability"></span></h2>
        </div>
      </div>
      <div id="county-container"></div>
    </div>

    <div class="col-lg-5 offset-lg-1">
      <div class="row">
        <div class="col-lg-6">
          <h4 class="chart-title">Chicago Municipal Pension Liability</h4>
          <h5 class="chart-subtitle"><span class="data-year"></span></h4>
        </div>
        <div class="col-lg-6 text-center">
          <small class="text-uppercase">Total Liability</small><br />
          <h2>$<span id="total-chicago-liability"></span></h2>
        </div>
      </div>
      <div id="chicago-container"></div>
    </div>

    <div class="col-lg-5">
      <div class="row">
        <div class="col-lg-6">
          <h4 class="chart-title">Downstate Municipal Pension Liability</h4>
          <h5 class="chart-subtitle"><span class="data-year"></span></h4>
        </div>
        <div class="col-lg-6 text-center">
          <small class="text-uppercase">Total Liability</small><br />
          <h2>$<span id="total-downstate-liability"></span></h2>
        </div>
      </div>
      <div id="downstate-container"></div>
    </div>

  </div>
</div>

<div class="row pt-5 pb-5 hidden" id="funding-by-system-no-data">
  <div class="col-lg-10 offset-lg-1 text-center my-auto">
    <h2>Dang! We have no system metadata for <span class="employer-data-year"></span>.</h2>
    <p>Here's why: tk tk tk.</p>
    <p class="text-center">
      <small>Looking for a person? <a href="#search">Jump to individual benefit search <i class="fas fa-arrow-circle-down"></i></a></small>
    </p>
  </div>
</div>

<div class="row">
  <div class="col-lg-8 offset-lg-2">
    <p>You can also examine a year-by-year, fund-by-fund breakdown of <strong>“employer normal cost”</strong> vs. <strong>“amortization cost.”</strong></p>

    <p>What does that mean?</p>

    <p><strong>“Employer normal cost”</strong> is a subset of a pension’s “normal cost” — the estimated price of fully funding the benefits earned by employees in a given year. So “employer normal cost” is the normal cost of the plan minus employee contributions.</p>

    <p>Employees pay their share through payroll deductions, but employers (the governments) have rarely, if ever, paid their full share, even when more robust payments under a nearly quarter-century financial rescue plan are taken into account.</p>

    <p><strong>“Amortization cost”</strong> is the present cost of making up for insufficient payments in the past.</p>

    <p>Employer normal cost is usually well less than half the total cost government bodies kick in each year to pay for their current and past pension obligations. The disconnect between employer normal cost and the total contribution made by employers is a good measure of how well a pension fund was funded in the past.</p>

    <div class="alert alert-secondary" role="alert">
      <i class="fas fa-info-circle fa-fw"></i> <strong>Use the dropdown menu</strong> at the top left of your screen view data from other funds.
    </div>
  </div>
</div>

<div class="clearfix sticky-top w-50">
  <div class="pt-5 pl-5 float-left">
    <div id="fund-toggle">
      <div class="dropdown">
        <button class="btn btn-lg btn-secondary dropdown-toggle" type="button" id="fundDropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        </button>
        <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
          {% for fund in pension_funds %}
            <span class="dropdown-item fund-dropdown-item">{{ fund }}</span>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<div id="fund-detail">

  <div class="row pt-5">
    <div class="col-lg-6 offset-lg-1">
      <div class="row">
        <div class="col-lg-6">
          <h4 class="chart-title">Pension Liability</h4>
          <h5 class="chart-subtitle"><span class="employer-name"></span> – <span class="employer-data-year"></span></h4>
        </div>
        <div class="col-lg-4 text-center my-auto">
          <small class="text-uppercase">Total Liability</small><br />
          <h2>$<span id="employer-liability-amount"></span></h2>
        </div>
      </div>
    </div>
  </div>

  <div class="row pt-3 h-100 text-center">
    <div class="col-lg-6 offset-lg-1">
      <div id="fund-container"></div>
    </div>
    <div class="col-lg-4 my-auto">
      <small class="text-uppercase">Funding Level</small><br />
      <h1><span id="funding-level" class="badge text-white"></span></h1>
    </div>
  </div>

  <div class="row py-5">
    <div class="col-lg-6 offset-lg-1">
      <h4 class="chart-title">Distribution of Employer Contribution</h4>
      <h5 class="chart-subtitle"><span class="employer-name"></span> – <span class="employer-data-year"></span></h4>
    </div>
    <div class="col-lg-4 text-center my-auto">
      <small class="text-uppercase">Total Employer Contribution</small><br />
      <h2>$<span id="employer-contribution-amount"></span></h2>
    </div>
  </div>

  <div class="row">
    <div id="amortization-cost" class="col-lg-10 offset-lg-1"></div>
  </div>

</div>

<div class="row pt-5 pb-5 hidden" id="fund-detail-no-data">
  <div class="col-lg-10 offset-lg-1 text-center my-auto">
    <h2>Dang! We have no metadata for <span class="employer-name"></span> in <span class="employer-data-year"></span>.</h2>
    <p>Here's why: tk tk tk.</p>
    <p class="text-center">
      <small>Looking for a person? <a href="#search">Jump to individual benefit search <i class="fas fa-arrow-circle-down"></i></a></small>
    </p>
  </div>
</div>

<a name="search"></a>

<div class="row pt-5">
  <div class="col-lg-8 offset-lg-2">
    <p>What’s more, as the BGA has since 2012, users will be able to track the money paid to thousands of retired public-sector employees in Illinois. This is searchable information from the pension funds, including Chicago, Cook County and statewide. You can use this tool to find out how these break these down on an annual basis.</p>

    <p>PS: This is data only for the 17 largest pension funds in Illinois and does not include the 600+ police and fire pension funds peppered throughout Illinois, many of which are also in fiscal trouble.</p>
  </div>
</div>

<div class="row pt-5">
  <div class="col-lg-10 offset-lg-1">
    <h2>Search <span class="employer-data-year"></span> <span class="employer-name"></span> Individual Pension Data</h2>
  </div>
</div>

<div class="row pt-5">
  <div class="col-lg-6 offset-lg-1">
    <h4 class="chart-title">Distribution of Individual Benefits</h4>
    <h5 class="chart-subtitle pb-2"><span class="employer-name"></span> – <span class="employer-data-year"></span></h4>
    <div id="benefit-distribution-chart"></div>
  </div>
  <div class="col-lg-4 text-center my-auto">
    <p>
      <small class="text-uppercase">Median Annual Benefit</small><br />
      <h2 class="pb-3">$<span id="median-benefit-amount"></span></h2>
    </p>

    <p>
      <small class="text-uppercase">Number of Benefits</small><br />
      <h2><span id="total-benefits"></span></h2>
    </p>
  </div>
</div>

<div class="row pt-5">
  <div class="col-lg-10 offset-lg-1">
    <p>
      <small>Search <span class="employer-data-year"></span> individual benefit data by full name, or by first or last name. For example, you can find <strong>John Doe</strong> by querying <em>John Doe</em>, <em>Doe</em>, or <em>John</em>. If searching by full name does not return the desired result, try a less specific first or last name search.</small>
    </p>

    <div class="table-responsive">
      <table class="table table-striped table-bordered" id="benefit-table">
        <thead>
          <tr>
            <th scope="col">First name</th>
            <th scope="col">Last name</th>
            <th scope="col">Amount</th>
            <th scope="col">Years of Service</th>
            <th scope="col">Final Salary</th>
            <th scope="col">Benefit Start Date</th>
            <th scope="col">Status</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'lib/highcharts.js' %}"></script>
<script src="https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.10.18/js/dataTables.bootstrap4.min.js"></script>
{% compress js %}
  <script type="module" src="{% static 'js/base.js' %}"></script>
  <script type="module">
    import { PensionsController, ChartHelper } from "js/base"

    var yearData = {{ data_by_year|safe }};
    var selectedYear = 2018;
    var selectedFund = 'Downstate/Suburban Teachers (TRS)';

    var chartHelper = new ChartHelper();
    var controller = new PensionsController(yearData, selectedYear, selectedFund, chartHelper, benefitTable);

    function makeAjaxUrl (currentController) {
      return "{% url 'benefit_list_json' %}" +
        '?data_year=' + controller.selectedYear +
        '&fund=' + controller.selectedFund;
    }

    controller.selectYear(selectedYear);
    controller.selectFund(selectedFund);

    $('#funding-by-system-no-data').css('min-height', $('#funding-by-system').height());
    $('#fund-detail-no-data').css('min-height', $('#fund-detail').height());

    var benefitTable = $('#benefit-table').DataTable({
      "dom": "Bfrtip",
      "order": [[ 2, "desc" ]],
      "columnDefs": [{ "orderable": false, "targets": [0, 6] }],
      "processing": true,
      "serverSide": true,
      "ajax": {
        type: 'GET',
        url: makeAjaxUrl(controller),
        error: function (response, status, code) {
          if ( response.status === 401 ) {
            window.location = '{% url "social:begin" "auth0" %}';
          } else {
            alert(response.responseText);
          }
        },
      },
      "responsive": true,
      "searchDelay": 1000,
    });

    $('.year-dropdown-item').click(function () {
      var selectedYear = $(this).text();

      controller.selectYear(selectedYear);
      controller.selectFund(controller.selectedFund);

      benefitTable.ajax.url(makeAjaxUrl(controller)).load();
    });

    $('.fund-dropdown-item').click(function () {
      var selectedFund = $(this).text();

      controller.selectFund(selectedFund);

      benefitTable.ajax.url(makeAjaxUrl(controller)).load();
    });
  </script>
{% endcompress %}
{% endblock %}
